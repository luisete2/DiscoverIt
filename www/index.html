<!DOCTYPE html>
<html>
    <head>
        <title>DiscoverIt - Una nueva forma de viajar</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile.flatui.css" />
        <link rel="stylesheet" href="css//jquery-ui.css" />
        <script src="lib/jquery.min.js" type="text/javascript"></script>
        <script src="lib/jquery-ui.min.js" type="text/javascript"></script>
        <script src="lib/spin.min.js" type="text/javascript"></script>
        <script src="lib/jquery.spin.js" type="text/javascript"></script>
        <script src="lib/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
        <script src="lib/fontawesome.js" type="text/javascript"></script>
        <script src="lib/jquery.base64.js" type="text/javascript"></script>
    </head>
    <body>
        <div data-role="page" id="landingPage" data-theme="d">
            <div data-role="header">
                <h1>¡Bienvenido!</h1>
            </div><!-- /header -->
            <div data-role="content">
                <p><b>Usuarios existentes</b></p>
                <a data-role="button" href="#loginPage">Iniciar sesión</a>
                <p><b>¿Aún no te has registrado?</b></p>
                <a data-role="button" id="toSignUp" href="#signUpPage" style="margin:0; padding:0">Registro</a>
                <p></p>
            </div><!-- /content -->
        </div><!-- /page -->
        <div data-role="page" id="loginPage" data-theme="d">
            <div data-role="header">
                <a data-rel="back" data-icon="carat-l">Volver</a>
                <h1>Iniciar sesión</h1>
            </div><!-- /header -->
            <div data-role="content">
                <label for="log-uname">Nombre de usuario</label>
                <input type="text" name="log-uname" id="log-uname" value="">
                <label for="log-password">Contraseña</label>
                <input type="password" name="log-password" id="log-password" value="">
                <button name="iniciarSesion" onclick="confirmLogin()">Iniciar sesión</button>
                <!--<a data-role="button" href="#resetPasswordPage">¿No puedes entrar?</a>-->
            </div><!-- /content -->
        </div>
        <div data-role="page" id="signUpPage" data-theme="d">
            <div data-role="header">
                <a data-rel="back" data-icon="carat-l">Volver</a>
                <h1>Registro</h1>
            </div><!-- /header -->
            <div data-role="content">
                <label for="username">Nombre de usuario</label>
                <input type="text" id="username" name="username" value="">
                <label for="password">Contraseña</label>
                <input type="password" id="password" name="password" value="">
                <label for="password-confirm">Confirma contraseña</label>
                <input type="password" id="password-confirm" name="password-confirm" value="">
                <button onclick="confirmRegistry()" name="confirmarRegistro">Confirmar registro</button>
            </div><!-- /content -->
        </div>
    </body>
    <script charset="utf-8" type="text/javascript">
        $(document).ready(function() {
            $.base64.utf8encode = true;
            checkIfOnline();
            db = openDatabase("local.db", '1.0', "LocalDB", 4 * 1024 * 1024);
            /*db.transaction(function (tx) {
                tx.executeSql("DROP TABLE localUsers");
            });*/
            db.transaction(function (tx) {
                tx.executeSql("CREATE TABLE IF NOT EXISTS localUsers (nick text primary key, pass text)");
            });
            var timer=window.setInterval(checkIfOnline,5000);
            window.StatusBar.overlaysWebView(false);
            window.StatusBar.backgroundColorByHexString('#000000');
        });
        $.fn.spin.presets.loading = {
            lines: 15, length: 41, width: 14, radius: 42, scale: 0.75, corners: 1, color: '#000', opacity: 0.25, rotate: 0, direction: 1, speed: 1, trail: 60, fps: 20, zIndex: 2e9, className: 'spinner', top: '50%', left: '50%', shadow: true, hwaccel: false, position: 'absolute'
        };
        var url='http://192.168.1.43/DiscoverIt/www/php/';
        function confirmRegistry() {
            if(document.getElementById('username').value){
                if(!document.getElementById('password').value){
                    window.alert('Por favor, introduce una contraseña');
                }else if(document.getElementById('password').value != document.getElementById('password-confirm').value){
                    window.alert('¡Las contraseñas no coinciden!');
                }else{
                    $.post(url+'di_loginFunctions.php', {
                        uname: document.getElementById('username').value,
                        password: document.getElementById('password').value,
                        confirmarRegistro: true
                    }, function(data, status) {
                        console.log(data);
                        if(data=='Usuario existente'){
                            window.alert('Ya existe un usuario con ese nombre. Por favor, inicia sesión.')
                            $.mobile.changePage("#loginPage");
                        }else if(data=="Registro exitoso"){
                            var encodedPass = $.base64.encode(document.getElementById('password').value, true);
                            console.log(encodedPass);
                            db.transaction(function (tx) {
                                tx.executeSql("INSERT INTO localUsers (nick, pass) VALUES (?,?)", [document.getElementById('username').value, encodedPass]);
                            });
                            window.alert('¡Usuario registrado con éxito!');
                            $.mobile.changePage("#loginPage");
                        }else{
                            window.alert('Algo ha fallado en el registro. Por favor intentelo de nuevo mas tarde.');
                        }
                        $('#signUpPage').spin(false);
                    });  
                }
            }else{
                window.alert('Introduce un nombre de usuario, por favor');
            }
        };
        function confirmLogin () {
            if(!document.getElementById('log-password').value){
                window.alert('Introduce la contraseña, por favor');
            }else{
                $('#loginPage').spin('loading');
                db.transaction(function (tx) {
                    tx.executeSql("SELECT * FROM localUsers WHERE nick=?", [document.getElementById('log-uname').value], function(tx, results) {
                        if(results.rows.length > 0) {
                            var decodedPass = $.base64.decode(results.rows.item(0).pass, true);
                            console.log(decodedPass);
                            if(decodedPass==document.getElementById('log-password').value){
                                window.alert('¡Login offline realizado con éxito!');
                                document.cookie = "username="+document.getElementById('log-uname').value+"; path=/";
                                window.location.replace("../www/main.html");
                            }else{
                                window.alert('Contraseña errónea. Por favor, introducela de nuevo.');
                            }
                            $('#loginPage').spin(false);
                        }else{
                            if(testConnection()==false){
                                window.alert('Lo sentimos, ese nombre no esta en la base de datos local. Conéctate a internet para comprobarlo con la base online.');
                                $('#loginPage').spin(false);
                            }else{
                                $.post(url+'di_loginFunctions.php', {
                                    uname: document.getElementById('log-uname').value,
                                    password: document.getElementById('log-password').value,
                                    iniciarSesion: true
                                }, function(data, status) {
                                    //console.log(data);
                                    if(data=="Login exitoso"){
                                        tx.executeSql("INSERT INTO localUsers (nick, pass) VALUES (?,?)", [document.getElementById('log-uname').value, $.base64.encode(document.getElementById('log-password').value, true)]);
                                        document.cookie = "username="+document.getElementById('log-uname').value+"; path=/";
                                        window.alert('¡Login realizado con éxito!');
                                        window.location.replace("../www/main.html");
                                    }else if(data=="Login fallido"){
                                        window.alert('Usuario o contraseña errónea. Por favor, introduce de nuevo las credenciales.');
                                    }else{
                                        window.alert('Algo falló en el login. Por favor, intentalo de nuevo mas tarde');
                                    } 
                                });  
                                $('#loginPage').spin(false);
                            }
                        }
                    });
                });
            }
        };
        function emailAddressIsValid(email) {
            var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email);
        };
        function testConnection() {
            jQuery.ajaxSetup({async:false});
            re="";
            r=Math.round(Math.random() * 10000);
            $.get("http://pinturasxix.com/Imagenes/Holanda/340/142.jpg",{subins:r},function(d){
                re=true;
            }).error(function(){
                re=false;
            });
            return re;
        }
        function checkIfOnline(){
            if(testConnection()==false){
                if (window.location.href.indexOf("signUpPage") > -1 ) {
                    window.alert('Se ha perdido la conexión a internet. Por favor, conecta el dispositivo de nuevo para realizar el registro.');
                    $.mobile.changePage( "#landingPage");
                }
                $("#toSignUp").button().button('disable'); 
                console.log('nocon');
            }else{
                $("#toSignUp").button().button('enable'); 
                console.log('haycon');
            }
        }
</script>
</html>